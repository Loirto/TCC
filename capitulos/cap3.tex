\chapter{O vírus polimórfico}

Na época do MS-DOS os vírus eram simples e divididos em categorias básicas: infectadores do setor de boot (boot sector\footnote{http://en.wikipedia.org/w/index.php?title=Boot\_sector\&oldid=524626394}), infectadores de arquivos .COM e infectadores de arquivos .EXE. Nesta época a vida também era relativamente fácil para os fabricantes de anti-vírus pois os vírus eram em menor número e a detecção era baseada em assinatura do código malicioso\footnote{A assinatura de um vírus é um padrão de bytes que identifica unicamente aquele vírus}. As atualizações dos anti-vírus eram em geral atualização da base de dados que continham as assinaturas, o tamanho e a forma de correção da infecção.

Um exemplo desta época é o vírus de boot sector Stoned\footnote{http://en.wikipedia.org/w/index.php?title=Stoned\_\%28computer\_virus\%29\&oldid=532807447} que infectou muitos computadores no final da década de 1980. A assinatura mais óbvia para este vírus seria \textbf{Your PC is now Stoned!} que o vírus exibia quando o computador estava inicializando. Portanto, um anti-virus da época precisaria apenas buscar esta string no registro de boot sector do disco rígido e dos disquetes que estivessem na unidade e, caso encontrasse, eliminar o vírus da memória - pois ele ficava residente infectando todo disquete que fosse colocado no computador - e em seguida substituir o boot sector pelo original que o vírus mantinha em outra localização do disco.

Algumas versões de vírus de boot sector eram um pouco mais inteligentes e assumiam controle da função de leitura de disco do BIOS. Assim, ao detectar que algum software estava tentando ler o boot sector, ele carregava a cópia original fazendo com que o anti-vírus não suspeitasse da existência da infecção. Logo, os desenvovedores de anti-vírus perceberam esta manobra e começaram a vasculhar a memória RAM do computador em busca de assinaturas de vírus e não mais somente em disco.

Também começaram a surgir cada vez mais vírus e a detecção por assinatura somente não estava mais dando certo pois novas variações do mesmo vírus tinham assinaturas diferentes. Por exemplo, o Stoned mencionado anteriormente teve muitas variações e buscar pela assinatura original não detectava mais o vírus pois a mensagem foi modificada. Então as empresas de anti-vírus começaram a desenvolver algorítmos que analisavam o código a fim de detectar certos padrões de execução (chamado código malicioso) que identificavam por certo um código que não deveria ser executado, utilizando análise heurística\footnote{http://en.wikipedia.org/w/index.php?title=Heuristic\_analysis\&oldid=529072201} \footnote{http://forums.avg.com/pt-pt/avg-forums?sec=thread\&act=show\&id=371}.

Então, os desenvolvedores de vírus perceberam que para evitar a detecção deveriam modificar a aparência do código. Foi assim que surgiram os vírus polimórficos.

\section{As partes do vírus polimórfico}

\section{Protegendo a rotina de decriptografia}
Conforme vimos, as técnicas de criptografia são eficientes para proteger o código polimórfico mas possuem um calcanhar de Aquiles: a rotina de decriptografia. Existem várias técnicas usadas para proteger esta rotina contra algoritmos de heurística, casamento de padrões e mesmo engenharia reversa. Vamos ver algumas delas.

\subsection{Técnicas anti-debugging} 
\footnote{pferrie.host22.com/papers/antidebug.pdf}
\footnote{http://en.wikipedia.org/w/index.php?title=Debugging\&oldid=533173326} 
\footnote{http://thelegendofrandom.com/blog/archives/2100} 
\footnote{http://www.symantec.com/connect/articles/windows-anti-debug-reference}
\footnote{web.eecs.umich.edu/~mibailey/publications/dsn08\_final.pdf} 
\footnote{research.dissect.pe/docs/blackhat2012-paper.pdf}
\footnote(Software: http://newgre.net/idastealth}
A engenharia reversa é largamente utilizada todos os dias, com propósitos nobres e outros não tão nobres assim:
\begin{itemize}
 \item Entender como funciona um algorítmo que teve o fonte perdido ou cujo fornecedor não existe mais.
 \item Estudar o código de um driver proprietário que não disponibiliza os fontes e que está com defeito ou que não existe versão para o SO desejado. 
 \item Estudar um código malicioso a fim de criar uma defesa contra o mesmo.
 \item Estudar um algorítmo para criar uma outra versão e obter lucro vendendo sua própria solução.
\end{itemize}

Muitas empresas querem proteger seu patrimônio intelectual e empregam além de criptografia técnicas para impedir ou dificultar muito a engenharia reversa em seus produtos. A seguir vamos analisar brevemente algumas das técnicas utilizadas. 


\section{Polimorfismo em linguagens interpretadas}
